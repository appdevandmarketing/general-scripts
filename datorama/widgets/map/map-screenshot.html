<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Title</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCpDwo7xPsiMbAgctxYJ_5tYNY4yKkU_SI&libraries=geometry"></script>
    <script>
      jQuery(async function ($) {
        const API_URL = "https://supernovaapp.rainlocal.com/campaign/targets/";
        const C_ZOOM_LEVEL = 10;
        const CTL_ZOOM_LEVEL = 12;
        const CT_ZOOM_LEVEL = 14;

        const loadedMapData = [];
        const loadedCoordinates = [];
        const loadedTargetLists = [];

        let googleMapsInstance = null;

        function isInitialized() {
          return googleMapsInstance !== null;
        }

        function init(centerLat, centerLng, zoomLevel, element = "map") {
          if (isInitialized() || !centerLat || !centerLng || !zoomLevel) {
            console.log("Map already created");
            return;
          }

          console.log("Init");
          const latLng = new google.maps.LatLng(centerLat, centerLng);
          const settings = {
            zoom: zoomLevel,
            center: latLng,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            disableDefaultUI: true,
          };

          googleMapsInstance = new google.maps.Map(
            document.getElementById(element),
            settings
          );
        }

        function chooseRandomColor() {
          const colors = [
            "#ff0000ff",
            "#00ff00ff",
            "#0000ffff",
            "#2E8B57ff",
            "#DC143CFF",
            "#4B0082FF",
            "#A0522DFF",
            "#006400FF",
            "#39C0ED",
            "#262626",
            "#FFA900",
            "#B23CFD",
            "#00B74A",
          ];
          const index = Math.floor(Math.random() * colors.length);
          return colors[index];
        }

        function kilometersToMeters(km) {
          return km * 1000;
        }

        function createCircle(circle, color, circleOptionsDefaults) {
          const tmp = Object.assign({}, circleOptionsDefaults);
          // Sets the color
          tmp.fillColor = color;
          tmp.strokeColor = color;

          tmp.map = googleMapsInstance;
          tmp.center = new google.maps.LatLng(
            circle.center.lat,
            circle.center.lng
          );
          tmp.radius = kilometersToMeters(circle.radius);

          return new google.maps.Circle(tmp);
        }

        function createPolygon(path, color, polygonDefaultOptions) {
          const tmp = Object.assign({}, polygonDefaultOptions);
          tmp.fillColor = color;
          tmp.strokeColor = color;

          tmp.paths = path;
          tmp.map = googleMapsInstance;

          return new google.maps.Polygon(tmp);
        }

        function addBoundsForGeoData(boundsArray, geoData, mapType) {
          if (mapType === "circle") {
            try {
              let latLng = new google.maps.LatLng(
                geoData.center.lat,
                geoData.center.lng
              );
              const bearings = [0, 90, 180, 270];
              const radius = kilometersToMeters(geoData.radius);
              bearings.forEach((bearing) => {
                const bound = google.maps.geometry.spherical.computeOffset(
                  latLng,
                  radius,
                  bearing
                );
                boundsArray.push(bound);
              });
            } catch (err) {
              console.log(err);
            }
          } else {
            geoData.forEach((gd) => {
              boundsArray.push(new google.maps.LatLng(gd.lat, gd.lng));
            });
          }
        }

        function fitBounds(boundsArray) {
          if (!isInitialized()) {
            return;
          }

          const bounds = new google.maps.LatLngBounds();
          boundsArray.forEach((marker) => {
            bounds.extend(marker);
          });
          googleMapsInstance.fitBounds(bounds);
        }

        function panToCampaign(campaigns) {
          const boundsArray = [];
          campaigns.forEach((campaign) => {
            campaign.campaignTargetLists.forEach((targetList) => {
              targetList.campaignTargets.forEach((target) => {
                const mapType = target.type;
                const geoData = JSON.parse(target.coordinates);
                addBoundsForGeoData(boundsArray, geoData, mapType);
              });
            });
          });

          fitBounds(boundsArray);
        }

        async function loadMapDataFromAPI() {
          const urlParams = new URLSearchParams(window.location.search);
          const campaignNumber = urlParams.get("campaignId");
          const response = await $.get(API_URL + campaignNumber);

          response.campaignTargetLists.forEach((targetList) => {
            let isCampaignTargetListLoaded = false;
            targetList.campaignTargets.forEach((target) => {
              if (loadedCoordinates.includes(target.coordinates)) {
                return;
              }
              isCampaignTargetListLoaded = true;
              loadedCoordinates.push(target.coordinates);

              const mapType = target.type;
              const geoData = JSON.parse(target.coordinates);

              if (mapType === "circle") {
                if (!isInitialized()) {
                  init(geoData.center.lat, geoData.center.lng, C_ZOOM_LEVEL);
                }
                createCircle(geoData, chooseRandomColor());
              } else {
                if (!isInitialized()) {
                  init(geoData[0].lat, geoData[0].lng, C_ZOOM_LEVEL);
                }
                createPolygon(
                  formatPolygonCoordinates(geoData),
                  chooseRandomColor(),
                  null
                );
              }
            });
            if (isCampaignTargetListLoaded) {
              loadedTargetLists.push(targetList);
            }
          });
          loadedMapData.push(response);
          if (isInitialized()) {
            panToCampaign(loadedMapData);
            googleMapsInstance.addListener("tilesloaded", () => {
              document.isReadyForScreenShot = "ok";
            });
          }
        }

        function formatPolygonCoordinates(polygonCoordinates) {
          if (!polygonCoordinates) {
            return [];
          }

          const formattedCoordinates = [];
          for (let i = 0; i < polygonCoordinates.length; i++) {
            formattedCoordinates.push(
              new google.maps.LatLng(
                polygonCoordinates[i].lat,
                polygonCoordinates[i].lng
              )
            );
          }
          return formattedCoordinates;
        }

        await loadMapDataFromAPI();
      });
    </script>
    <style>
      html,
      body,
      #map {
        height: 100%;
        width: 100%;
        overflow: hidden;
        margin: 0px;
        padding: 0px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
  </body>
</html>
